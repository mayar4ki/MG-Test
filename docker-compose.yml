# Docker Compose for local development and testing
#
# Usage:
#   docker compose up              - Start all services
#   docker compose up --build      - Rebuild and start
#   docker compose up api socket   - Start specific services
#
# All environment variables are REQUIRED - create a .env file with:
#   PORT, JWT_SECRET, GATEWAY_PORT, AUTH_INTROSPECT_URL,
#   AUTH_INTROSPECT_CACHE_TTL_MS, REDIS_URL, REDIS_PASSWORD,
#   WEB_PORT, NEXT_PUBLIC_BACKEND_URL, NEXT_PUBLIC_SOKCET_GETWAY_URL

services:
  api:
    build:
      context: .
      dockerfile: apps/back-end/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    environment:
      - PORT=${PORT:?PORT is required}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
    ports:
      - "${PORT:?PORT is required}:${PORT:?PORT is required}"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${PORT:?}/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  socket:
    build:
      context: .
      dockerfile: apps/socket-gateway/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    depends_on:
      api:
        condition: service_started
      redis:
        condition: service_started
    environment:
      - GATEWAY_PORT=${GATEWAY_PORT:?GATEWAY_PORT is required}
      - AUTH_INTROSPECT_URL=${AUTH_INTROSPECT_URL:?AUTH_INTROSPECT_URL is required}
      - AUTH_INTROSPECT_CACHE_TTL_MS=${AUTH_INTROSPECT_CACHE_TTL_MS:?AUTH_INTROSPECT_CACHE_TTL_MS is required}
      - REDIS_URL=${REDIS_URL:?REDIS_URL is required}
    ports:
      - "${GATEWAY_PORT:?GATEWAY_PORT is required}:${GATEWAY_PORT:?GATEWAY_PORT is required}"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${GATEWAY_PORT:?}/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web:
    build:
      context: .
      dockerfile: apps/web-app/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
        NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:?NEXT_PUBLIC_BACKEND_URL is required}
        NEXT_PUBLIC_SOKCET_GETWAY_URL: ${NEXT_PUBLIC_SOKCET_GETWAY_URL:?NEXT_PUBLIC_SOKCET_GETWAY_URL is required}
    depends_on:
      - api
      - socket
    ports:
      - "${WEB_PORT:?WEB_PORT is required}:${WEB_PORT:?WEB_PORT is required}"
    environment:
      - PORT=${WEB_PORT:?WEB_PORT is required}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${WEB_PORT:?}" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  redis:
    image: redis:7-alpine
    command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD:?REDIS_PASSWORD is required}" ]
    # Not exposed to host - only accessible within Docker network
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD:?}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  redis-data:
